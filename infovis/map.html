
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TP InfoVis ITBA 2015/I</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <style>
	html { 
	  color: #333;
	  font-family: sans-serif;
	  font-weight: 100;
	  line-height: 1.5em;
	  text-align: center;
	}
	h1, h2 { text-align:center; }
	h2 { font-size:1.2em; margin-top:20px; margin-bottom:10px; }
	.wrapper { width:920px; position:relative; margin:auto; max-width:100%; }
	.left-container { width:400px;}
	.map-container {  width:400px; height:350px; border:1px solid #DDDDDD; float: left; margin-right:30px; }
	.count-container {  width:400px; margin-top:20px; border:1px solid #DDDDDD; float: left; margin-right:30px; }
	.right-container { width:500px; margin-left:418px; border:1px solid #DDDDDD;}
	.heatmap { width:100%; height:100%; }
	.fa {color: #888888;}	
//	#addressChartContainer { margin-top:20px; border:1px solid #DDDDDD;}
	#date {	  font-size: 13pt; display : inline-block; min-width: 250px;}
	#time {   font-size: 13pt;  display : inline-block; min-width: 170px;}
	.subtitle {font-size: 11pt;}
  </style>
</head>
<body>
  <div class="wrapper">
	<div class="left-container">
		<div class="map-container">
			<div class="heatmap" id="map-canvas">
			</div>
		</div>
		<div class="count-container">
			<div id="countChartContainer">
			</div>  
		</div>  
	</div>
	<div class="right-container">
		<p>
			<i id="btnDayBefore" class="fa fa-arrow-circle-left"></i>&nbsp;	<span  id="date"></span>&nbsp;<i id="btnDayAfter" class="fa fa-arrow-circle-right"></i><br/>
			<i id="btnHourBefore" class="fa fa-arrow-circle-left"></i>&nbsp;<span  id="time"></span>&nbsp;<i id="btnHourAfter" class="fa fa-arrow-circle-right"></i>
		</p>
		<div id="addressChartContainer">
			<!--<p class="subtitle">10 esquinas m√°s buscadas</p>-->
		</div>  
	</div>  
  </div>
  <script src="js/heatmap.min.js"></script>
  <script src="js/leaflet-heatmap.js"></script>
  <script src="js/locations.js"></script>
  <script src="js/hourly.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.1.6.min.js"></script>
  <script>
    window.onload = function() {
        var baseLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            attribution: '',
            maxZoom: 18
          }
        );

        var cfg = {
          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
          "radius": 0.005,
          "maxOpacity": .8, 
          // scales the radius based on map zoom
          "scaleRadius": true, 
          // if set to false the heatmap uses the global maximum for colorization
          // if activated: uses the data maximum within the current map boundaries 
          //   (there will always be a red spot with useLocalExtremas true)
          "useLocalExtrema": false,
          // which field name in your data represents the latitude - default "lat"
          latField: 'lat',
          // which field name in your data represents the longitude - default "lng"
          lngField: 'lng',
          // which field name in your data represents the data value - default "value"
          valueField: 'count'
        };


        var heatmapLayer = new HeatmapOverlay(cfg);

        var map = new L.Map('map-canvas', {
          center: new L.LatLng(-34.62, -58.42),
          zoom: 11,
          layers: [baseLayer,heatmapLayer]
        });


	var countSvg = dimple.newSvg("#countChartContainer", 386, 210);
	var countChart = new dimple.chart(countSvg);
	countChart.setBounds(30, 30, 340, 160);
	countChart.ease = "quad";
	var x = countChart.addCategoryAxis("x", "Hora");
	var y = countChart.addMeasureAxis("y", "Consultas");
	x.addOrderRule("Hora");
	x.title="";
	y.title="";
	var series=countChart.addSeries(null, dimple.plot.bar);	
	series.afterDraw = function (shape, data) {
		var s = d3.select(shape);
		if (data.x==currentTimeOfDay) {
			s.style('fill', d3.rgb(38, 107, 211));
		} else {
			s.style('fill', d3.rgb(128, 177, 211));
		}
	}

	var addressSvg = dimple.newSvg("#addressChartContainer", 480, 500);
	var addressChart = new dimple.chart(addressSvg);
	addressChart.setBounds(250, 10, 200, 450)
	addressChart.ease = "quad";
	var x1 = addressChart.addMeasureAxis("x", "Consultas");
	x1.tickFormat="d";
	x1.title="";
	var y1 = addressChart.addCategoryAxis("y", "Esquina");
	y1.addOrderRule("Consultas");
	y1.title="";
	addressChart.addSeries(null, dimple.plot.bar);	

 	var  generalIndex=0;
 	var  currentTimeOfDay=0;


	d3.select("#btnDayAfter").on("click", 
		function(d,i){
			generalIndex+=24;
			if (generalIndex>=hourly.length) generalIndex=hourly.length-1;
			update();
		}
	);
	d3.select("#btnDayBefore").on("click", 
		function(d,i){
			generalIndex-=24;
			if (generalIndex<0) generalIndex=0;
			update();
		}
	);
	d3.select("#btnHourBefore").on("click", 
		function(d,i){
			generalIndex-=1;
			if (generalIndex<0) generalIndex=0;
			update();
		}
	);
	d3.select("#btnHourAfter").on("click", 
		function(d,i){
			generalIndex+=1;
			if (generalIndex>=hourly.length) generalIndex=hourly.length-1;
			update();
		}
	);


	update = function(){
   		heatmapLayer.setDataFunction({ max: 100, data: hourly[""+generalIndex].data }, function(d) { 
			return {"lat":locations[d[0]][0],"lng":locations[d[0]][1],"count":d[1]};
		});


		d3.select("#date").text(hourly[""+generalIndex].date);
		d3.select("#time").text(hourly[""+generalIndex].time+":00 hs a "+(hourly[""+generalIndex].time+1)+":00 hs");

		currentTimeOfDay=hourly[""+generalIndex].time;

		var topCount=30;
		var topdata=hourly[""+generalIndex].data.slice(0,topCount);
		var top=new Array();
		for (j=0; j<topCount;j++) {
			var data = topdata[j];
			top.push({"Esquina":locations[data[0]][2], "Consultas":data[1]});			
		}
		addressChart.data=top;
		addressChart.draw(500);


		var frecuencies=new Array();
		for (j=Math.max(0,generalIndex-24); j<Math.min(hourly.length,generalIndex+24);j++) {
			if (hourly[""+j].date==hourly[""+generalIndex].date) {
				frecuencies.push({"Hora":hourly[""+j].time, "Consultas":hourly[""+j].count});			
			}
		}
		countChart.data=frecuencies;
	        countChart.draw(200);
	}
	update();

  }	





  </script>

</body>
</html>
